<!DOCTYPE html>
<html><head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=443&amp;path=blog/livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>shutil.make_archive()が止まらない - green light</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="shutil.make_archive()が止まらない" />
<meta property="og:description" content="事の発端 最近、自分の作った画像解析ソフトウェアをStreamlitでWebアプリケーション化して、研究所のプログラミングに明るくないメンバーに使ってもらっています。Streamlitは（簡単なものなら）かなり簡単に作れるため、プロトタイピン" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0kam.net/blog/posts/make_archive/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-02-12T07:36:50+09:00" />
<meta property="article:modified_time" content="2025-02-12T07:36:50+09:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="shutil.make_archive()が止まらない"/>
<meta name="twitter:description" content="事の発端 最近、自分の作った画像解析ソフトウェアをStreamlitでWebアプリケーション化して、研究所のプログラミングに明るくないメンバーに使ってもらっています。Streamlitは（簡単なものなら）かなり簡単に作れるため、プロトタイピン"/>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="https://0kam.net/blog/css/main.css" /><link rel="stylesheet" type="text/css" href="https://0kam.net/blog/css/dark.css" media="(prefers-color-scheme: dark)" />
</head>

<head>
    
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://0kam.net/blog/">green light</a>
	</div>
	<nav>
		
		<a href="../../">Home</a>
		
		<a href="../../posts">All posts</a>
		
		<a href="../../about">About</a>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">shutil.make_archive()が止まらない</h1>
			<div class="meta">Posted on Feb 12, 2025</div>
		</div>
		

		<section class="body">
			<h2 id="事の発端">事の発端</h2>
<p>最近、自分の作った画像解析ソフトウェアを<a href="https://streamlit.io/">Streamlit</a>でWebアプリケーション化して、研究所のプログラミングに明るくないメンバーに使ってもらっています。Streamlitは（簡単なものなら）かなり簡単に作れるため、プロトタイピングに大変便利ですね！しかし、今日ユーザーから、いつまで経っても処理が終わらない、という報告を受けました。ログを見ると、<code>shutil.make_archive()</code>が<code>No space left on device</code>とだけ言い残して死んでいます。あれ、ホストしてるマシンはSSDのスペースまだかなり余っていたはずだけど、と思って<code>df</code>コマンドを叩いてみると、<code>/</code>以下の使用率が100%近くなっていました。</p>
<h2 id="何故か">何故か</h2>
<p><strong>A: <code>shutil.make_archive('test/out', 'zip', root_dir='test')</code>のように、アーカイブ対象のディレクトリ内でZIPファイルを作ったせいで、再帰的にZIPファイルが巨大化してしまった。</strong></p>
<p>Streamlitを使ったウェブアプリでは、解析結果は<code>tempfile.TemporaryDirectory()</code>で作成した一時ディレクトリ内に保存し、それを最後にzipファイルにまとめてダウンロードする仕組みにしています。ここで、うっかり上記のように、<code>root_dir</code>内にzipファイルを作ることで、デバイスの容量を圧迫してプログラムが死ぬまでzipファイルが膨れ上がる現象が生じてしまったようです。</p>
<p>ちなみに、Unixのzipコマンドで同様の事（<code>zip -r test/out.zip test</code>）を行っても、<code>test/</code>内に<code>out.zip</code>が常識的なファイルサイズで作成されます。今回の一件はかなりしょぼいミスが原因（なぜテストで気が付かなかったのか？）でしたが、その代償が大きすぎるというか、<a href="https://ja.wikipedia.org/wiki/%E9%AB%98%E5%9C%A7%E7%B8%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E7%88%86%E5%BC%BE">zip爆弾</a>のように何らかの脆弱性にもつながりそうだと思いました。</p>
<h2 id="再現コード">再現コード</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── test
</span></span><span style="display:flex;"><span>│   └── large_image.png
</span></span><span style="display:flex;"><span>└── test.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>❯ python -V
</span></span><span style="display:flex;"><span>Python 3.10.14                                             
</span></span></code></pre></div><p><code>large_image.png</code>には、zipファイルの膨張が実感できるように、それなりに大きいファイルを入れておきます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># test.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span>shutil<span style="color:#f92672">.</span>make_archive(<span style="color:#e6db74">&#34;test/test&#34;</span>, <span style="color:#e6db74">&#34;zip&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>❯ python test.py
</span></span></code></pre></div><p>以下のように、順調に（？）ファイルサイズが大きくなっていくのがわかります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>❯ du
</span></span><span style="display:flex;"><span>142704	./test
</span></span><span style="display:flex;"><span>142708	.
</span></span><span style="display:flex;"><span>❯ du
</span></span><span style="display:flex;"><span>326996	./test
</span></span><span style="display:flex;"><span>327000	.
</span></span><span style="display:flex;"><span>❯ du
</span></span><span style="display:flex;"><span>559856	./test
</span></span><span style="display:flex;"><span>559860	.
</span></span><span style="display:flex;"><span>❯ du
</span></span><span style="display:flex;"><span>950052	./test
</span></span><span style="display:flex;"><span>950056	.
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="../../tags/linux">Linux</a></li>
					
					<li><a href="../../tags/python">Python</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
<hr><a class="soc" href="https://www.facebook.com/profile.php?id=100010006816605" title="Facebook"><i data-feather="facebook"></i></a>|⚡️
	2025  © okamoto |  <a href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
</footer>
<script>
      feather.replace()
</script>

</div>
    </body>
</html>
