<!DOCTYPE html>
<html><head lang="en"><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>安価な積雪深ロガーの自作 - green light</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="はじめに
積雪量は気候変動を考える上で重要な指標である一方、地形などによって空間的な不均質性が高くなりがちで計測が難しい対象だと言えます。大量に積雪深計をばら撒いてデータをたくさん取れると良いですが、ちゃんとした積雪深計は結構値段が高く（数十万円）、気軽に大量購入はできません。" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/blog/posts/snowdepth_logger/">
  <meta property="og:site_name" content="green light">
  <meta property="og:title" content="安価な積雪深ロガーの自作">
  <meta property="og:description" content="はじめに 積雪量は気候変動を考える上で重要な指標である一方、地形などによって空間的な不均質性が高くなりがちで計測が難しい対象だと言えます。大量に積雪深計をばら撒いてデータをたくさん取れると良いですが、ちゃんとした積雪深計は結構値段が高く（数十万円）、気軽に大量購入はできません。">
  <meta property="og:locale" content="jp">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-19T06:30:51+09:00">
    <meta property="article:modified_time" content="2025-11-19T06:30:51+09:00">
    <meta property="article:tag" content="Spresense">
    <meta property="article:tag" content="Arduino">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="安価な積雪深ロガーの自作">
  <meta name="twitter:description" content="はじめに 積雪量は気候変動を考える上で重要な指標である一方、地形などによって空間的な不均質性が高くなりがちで計測が難しい対象だと言えます。大量に積雪深計をばら撒いてデータをたくさん取れると良いですが、ちゃんとした積雪深計は結構値段が高く（数十万円）、気軽に大量購入はできません。">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/blog/css/main.4e31546101ee9728613071f3410cf21f481e1a76df22c2dda8457a80d04dde26.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/blog/css/dark.deccb94d40bc8feabc208f71c6bb0225a06ff8f1760a7b9091a7901ab245516c.css" media="(prefers-color-scheme: dark)"  />
</head><body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">green light</a>
	</div>
	<nav>
		
		<a href="../../">Home</a>
		
		<a href="../../posts">All posts</a>
		
		<a href="../../about">About</a>
		
		<a href="../../tags">Tags</a>
		
		
	</nav>
</header>
<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">安価な積雪深ロガーの自作</h1>
          <div class="meta">Posted on Nov 19, 2025</div>
        </div>
        
        <section class="body">
          <h2 id="はじめに">はじめに</h2>
<p>積雪量は気候変動を考える上で重要な指標である一方、地形などによって空間的な不均質性が高くなりがちで計測が難しい対象だと言えます。大量に積雪深計をばら撒いてデータをたくさん取れると良いですが、ちゃんとした積雪深計は結構値段が高く（数十万円）、気軽に大量購入はできません。</p>
<p>一方、積雪深計の仕組み自体は簡単な（高いところにつけておいて、雪面までの距離を測れればいい）ので、自分でも作れるのでは？と思いました。</p>
<p>ここでは、Sony SpresenseとSeeed社の安価な超音波距離計を使って、1.5万円くらいで毎日決まった時間に積雪深を計測するロガーを作る方法をメモがわりに書いておきます。なお、本積雪深計はまだテストしておらず、精度も保証できません。</p>
<h2 id="全体構成">全体構成</h2>
<p><img src="../../images/snowdepth_logger/logger.png" alt=""></p>
<h3 id="マイコン">マイコン</h3>
<p>今回は、Sony製のArduino互換マイコンSpresenseを使います。
Spresenseを使う理由は、</p>
<ul>
<li>Arduino互換で開発が楽</li>
<li>GNSS、RTCが内蔵されており、野外での自動時刻校正や間欠動作が簡単に実装できる</li>
<li>拡張ボードを使えばmicroSDへのデータ書き込みも簡単</li>
</ul>
<p>という感じで色々便利だからです。マイコンにしてはちょっと高いですが&hellip;</p>
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/g114584/">Sony Spresense</a></li>
<li><a href="https://akizukidenshi.com/catalog/g/g114585/">Spresense拡張ボード</a></li>
</ul>
<h3 id="超音波距離計">超音波距離計</h3>
<p><a href="https://www.switch-science.com/products/8872">Seeed Studio社の防水超音波距離センサー</a>を使いました。7.5mまで測れて防水、ケーブルグランド様の形状で箱への取り付けも簡単という便利な商品です。が、この記事を書いている時点で売り切れており、公式通販でも売ってなさそうなので終売っぽいですね。</p>
<p>やや測定範囲が狭いですが、<a href="https://www.switch-science.com/products/9215?_pos=26&amp;_sid=acd8b4cd8&amp;_ss=r">これ</a>とかが代替になるかもしれません。</p>
<h3 id="トランシーバー">トランシーバー</h3>
<p>今回使った距離計はRS485で通信を行うので、データの受信にはトランシーバが必要です。
ここでは、<a href="https://akizukidenshi.com/catalog/g/g102792/">LTC485CN8</a>を使いました。</p>
<h3 id="電池">電池</h3>
<p>単三乾電池 x 4で駆動させます。</p>
<h2 id="配線">配線</h2>
<p>LTC485CN8との通信にはSerial2を使い、RS485の受送信切り替えにはGPIO7を使います。
距離計とLTC485CN8の電源はSpresenseのVout(5.0V)から取りました。</p>
<p><img src="../../images/snowdepth_logger/fritzing.png" alt=""></p>
<h2 id="パッキング">パッキング</h2>
<p>箱は物置に転がっていたBoxcoの防水プラボックスを使いました。これはもう終売になっていますが、タカチで言うとBCAP101507Tくらいのサイズ感のものです（外寸140mm x 100mm x 85mm程度）。</p>
<p>ボックスの底面に29mmの穴を開け、距離計を固定します。
乾電池4本を入れた電池ボックスも一緒に格納しました。</p>
<h2 id="arduinoスケッチ">Arduinoスケッチ</h2>
<p>ソフトウェアはArduinoIDEを使って開発しました。
実装した主な機能は以下のような感じです。</p>
<ul>
<li>起動時にGNSSシグナルを受信してRTC（内部時計）を校正</li>
<li>冒頭の&quot;schedule&quot;で指定された時刻にロギングを実施<br>
例：毎時0分、30分にロギング
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  schedule s <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">24</span>, {<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">30</span>}};
</span></span></code></pre></div></li>
<li>1回のロギングでは1秒間隔で10回距離計測</li>
<li>1回のロギングごとにCSVを作成して保存</li>
<li>ロギングが終わったら次の起動時刻を計算してディープスリープ</li>
</ul>
<details>
<summary> Arduinoスケッチ </summary>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Name: RS485_US_sensor.ino
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Author: Ryotaro Okamoto
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Started: 2025/11/19
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Last Modified: 2025/11/19
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Purpose: To perform time-lapse logging of snow depth level using Sony Spresense
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Description:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Ultrasonic Level Sensor : https://www.seeedstudio.com/RS485-750cm-Ultrasonic-Level-Sensor-p-5587.html?qid=8E73JB_4boj71q2_1763535329310
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">RS485 transceiver : https://akizukidenshi.com/catalog/g/g102792/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Libraries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Arduino.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// Below is for Spresense
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;GNSS.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;LowPower.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arch/board/board.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;RTC.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Watchdog.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SDHCI.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Defining pins for the level sensor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define RS485_TXEN_PIN 7   </span><span style="color:#75715e">// LTC485 DE/RE 制御ピン
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define RS485_SERIAL Serial2 </span><span style="color:#75715e">// Use UART2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define GNSS_STATUS_LED 6 </span><span style="color:#75715e">// GNSSの受信状況を表示するLEDのピン。VCC -&gt; LED -&gt; GNSS_STATUS_LED の順に繋ぐ。LOWで点灯。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> SLAVE_ADDR <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint16_t</span> REG_DISTANCE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0100</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> FUNC_READ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ロギング回数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> num_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;   <span style="color:#75715e">// 1回のロギングで何回計測するか。計測結果は全てCSVに保存する。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> measure_interval_ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;  <span style="color:#75715e">// 1秒ごと
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SDClass theSD;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Defining the schedule structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> { 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> start_h;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> end_h;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> m[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>} schedule;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define BAUDRATE 115200
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MY_TIMEZONE_IN_SECONDS (9 * 60 * 60) </span><span style="color:#75715e">// 9 * 60 * 60 means JST. Modify if required since the GNSS time is UTC.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> wd_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">65000</span>; <span style="color:#75715e">// Watchdog time in ms. if the main loop took more than wd_time, the watchdog will reset the process.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Time-lapse Parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span>schedule s <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">24</span>, {<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">55</span>}}; <span style="color:#75715e">// {start time (O&#39;clock), end time (O&#39;clock), {start time in every hour}}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Example: schedule s = {9,18, {0, 30}}; means that the logging starts at 0min, 30min in every hour from 9:00 to 18:00.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//If you specify s = {17,7,{0,20,40}}, The logging will be start at 17:00 and stop at 7:00 (7:20 and 7:40 will not be created).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* デバッグモード切り替え
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">---------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// デバッグ用フラグ（開発時はtrue、運用時はfalse）。trueにするとシリアル出力が出る。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define DEBUG_MODE false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// デバッグ用マクロ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if DEBUG_MODE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_PRINT(x) Serial.print(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_PRINTLN(x) Serial.println(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_BEGIN(x) Serial.begin(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_PRINT(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_PRINTLN(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#define DEBUG_BEGIN(x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* For timelapse operation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Define when to start logging
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> logging_start_second <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// start logging at 0 sec of each minutes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Wating time between boot and logging
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> boot_to_record_delay <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>; <span style="color:#75715e">// boot 10 sec earlier than the logging time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> boot_cause_strings[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Power On Reset with Power Supplied&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;System WDT expired or Self Reboot&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Chip WDT expired&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;WKUPL signal detected in deep sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;WKUPS signal detected in deep sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;RTC Alarm expired in deep sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;USB Connected in deep sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Others in deep sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;SCU Interrupt detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;RTC Alarm0 expired in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;RTC Alarm1 expired in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;RTC Alarm2 expired in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;RTC Alarm Error occurred in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Unknown(13)&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Unknown(14)&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Unknown(15)&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GPIO detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;SEN_INT signal detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;PMIC signal detected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;USB Disconnected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;USB Connected in cold sleep&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Power On Reset&#34;</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printBootCause</span>(bootcause_e bc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;--------------------------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>  DEBUG_PRINT(<span style="color:#e6db74">&#34;Boot Cause: &#34;</span>);
</span></span><span style="display:flex;"><span>  DEBUG_PRINT(boot_cause_strings[bc]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((COLD_GPIO_IRQ36 <span style="color:#f92672">&lt;=</span> bc) <span style="color:#f92672">&amp;&amp;</span> (bc <span style="color:#f92672">&lt;=</span> COLD_GPIO_IRQ47)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Wakeup by GPIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> pin <span style="color:#f92672">=</span> LowPower.getWakeupPin(bc);
</span></span><span style="display:flex;"><span>    DEBUG_PRINT(<span style="color:#e6db74">&#34; &lt;- pin &#34;</span>);
</span></span><span style="display:flex;"><span>    DEBUG_PRINT(pin);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN();
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;--------------------------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SpGnss Gnss;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>String <span style="color:#a6e22e">printClock</span>(RtcTime <span style="color:#f92672">&amp;</span>rtc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf [<span style="color:#ae81ff">13</span>];
</span></span><span style="display:flex;"><span>  sprintf(buf,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;%04d%02d%02d_%02d%02d&#34;</span>,
</span></span><span style="display:flex;"><span>          rtc.year(), rtc.month(), rtc.day(),
</span></span><span style="display:flex;"><span>          rtc.hour(), rtc.minute()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>  String str <span style="color:#f92672">=</span> String(buf);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> str;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setRTC</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize RTC at first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  RTC.begin();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize and start GNSS library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>  ret <span style="color:#f92672">=</span> Gnss.begin();
</span></span><span style="display:flex;"><span>  assert(ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  Gnss.select(GPS); <span style="color:#75715e">// GPS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Gnss.select(QZ_L1CA); <span style="color:#75715e">// QZSS  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Gnss.select(QZ_L1S);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ret <span style="color:#f92672">=</span> Gnss.start();
</span></span><span style="display:flex;"><span>  assert(ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Wait for GNSS data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> led_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (Gnss.waitUpdate()) {
</span></span><span style="display:flex;"><span>      SpNavData  NavData;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get the UTC time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Gnss.getNavData(<span style="color:#f92672">&amp;</span>NavData);
</span></span><span style="display:flex;"><span>      SpGnssTime <span style="color:#f92672">*</span>time <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>NavData.time;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Check if the acquired UTC time is accurate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      DEBUG_PRINTLN(time<span style="color:#f92672">-&gt;</span>year);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (time<span style="color:#f92672">-&gt;</span>year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2000</span> <span style="color:#f92672">&amp;&amp;</span> time<span style="color:#f92672">-&gt;</span>year <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2100</span>) {
</span></span><span style="display:flex;"><span>        RtcTime now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Convert SpGnssTime to RtcTime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        RtcTime gps(time<span style="color:#f92672">-&gt;</span>year, time<span style="color:#f92672">-&gt;</span>month, time<span style="color:#f92672">-&gt;</span>day,
</span></span><span style="display:flex;"><span>                    time<span style="color:#f92672">-&gt;</span>hour, time<span style="color:#f92672">-&gt;</span>minute, time<span style="color:#f92672">-&gt;</span>sec, time<span style="color:#f92672">-&gt;</span>usec <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Set the time difference
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        gps <span style="color:#f92672">+=</span> MY_TIMEZONE_IN_SECONDS;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> diff <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> gps;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (abs(diff) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          RTC.setTime(gps);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Gnss.stop() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)                
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Gnss stop error!!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (Gnss.end() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)            
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Gnss end error!!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        digitalWrite(GNSS_STATUS_LED, HIGH);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;        
</span></span><span style="display:flex;"><span>      }      
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// While wating for GNSS signals, the green LED of the Spresense Main Board will be blinking slowly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Waiting for GNSS signals...&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (led_state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      digitalWrite(GNSS_STATUS_LED, LOW);
</span></span><span style="display:flex;"><span>      led_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      digitalWrite(GNSS_STATUS_LED, HIGH);
</span></span><span style="display:flex;"><span>      led_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLowPower</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  bootcause_e bc <span style="color:#f92672">=</span> LowPower.bootCause();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((bc <span style="color:#f92672">==</span> POR_SUPPLY) <span style="color:#f92672">||</span> (bc <span style="color:#f92672">==</span> POR_NORMAL)) {
</span></span><span style="display:flex;"><span>    DEBUG_PRINTLN(<span style="color:#e6db74">&#34;First boot!&#34;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    DEBUG_PRINTLN(<span style="color:#e6db74">&#34;wakeup from deep sleep&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Print the boot cause
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  printBootCause(bc);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">findMinute</span>(schedule s, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>next_minute, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>next_hour, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>next_date, RtcTime <span style="color:#f92672">&amp;</span>rtc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> find_m <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> m_len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(s.m) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Find a minute later than current time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> m_len; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (s.m[i] <span style="color:#f92672">&gt;</span> rtc.minute()){
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>next_minute <span style="color:#f92672">=</span> s.m[i];
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>next_hour <span style="color:#f92672">=</span> rtc.hour();
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>next_date <span style="color:#f92672">=</span> rtc.day();  <span style="color:#75715e">// No date change since it&#39;s within the same hour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      find_m <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If no minute found later than current time, use the first minute of next hour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>find_m)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>next_hour <span style="color:#f92672">=</span> rtc.hour() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>next_date <span style="color:#f92672">=</span> rtc.day();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle case when hour exceeds 24
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>next_hour <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">24</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>next_hour <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>next_date <span style="color:#f92672">=</span> rtc.day() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">waitUntilShootTime</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// クロックを下げる
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Wating...&#34;</span>);
</span></span><span style="display:flex;"><span>  LowPower.clockMode(CLOCK_MODE_8MHz);
</span></span><span style="display:flex;"><span>  RtcTime now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> target_second <span style="color:#f92672">=</span> logging_start_second;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 目標秒まで何秒待つ必要があるか計算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> seconds_to_wait;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (now.second() <span style="color:#f92672">&lt;=</span> target_second) {
</span></span><span style="display:flex;"><span>    seconds_to_wait <span style="color:#f92672">=</span> target_second <span style="color:#f92672">-</span> now.second();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    seconds_to_wait <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">-</span> now.second() <span style="color:#f92672">+</span> target_second;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1秒以上待つ必要がある場合はその秒数分delay
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (seconds_to_wait <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    delay(seconds_to_wait <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">// 1秒前に起きる
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 最後の1秒以下は通常の待機（精度のため）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (now.second() <span style="color:#f92672">!=</span> target_second)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    delay(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  LowPower.clockMode(CLOCK_MODE_32MHz);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getNextAlarm</span>(schedule s, RtcTime <span style="color:#f92672">&amp;</span>rtc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> next_hour;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> next_date <span style="color:#f92672">=</span> rtc.day();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (s.start_h <span style="color:#f92672">&gt;</span> s.end_h)  <span style="color:#75715e">// Date-crossing schedule (e.g., 17:00~5:00)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rtc.hour() <span style="color:#f92672">&lt;</span> s.start_h)  <span style="color:#75715e">// Current time is before start time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (rtc.hour() <span style="color:#f92672">&lt;</span> s.end_h)  <span style="color:#75715e">// Current time is before end time (within logging period)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      {
</span></span><span style="display:flex;"><span>        findMinute(s, <span style="color:#f92672">&amp;</span>next_minute, <span style="color:#f92672">&amp;</span>next_hour, <span style="color:#f92672">&amp;</span>next_date, rtc);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>  <span style="color:#75715e">// Current time is outside logging period (e.g., between 5:00~17:00)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      {
</span></span><span style="display:flex;"><span>        next_hour <span style="color:#f92672">=</span> s.start_h;
</span></span><span style="display:flex;"><span>        next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        next_date <span style="color:#f92672">=</span> rtc.day();  <span style="color:#75715e">// Start time of today
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }      
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>  <span style="color:#75715e">// Current time is after start time (within logging period)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>      findMinute(s, <span style="color:#f92672">&amp;</span>next_minute, <span style="color:#f92672">&amp;</span>next_hour, <span style="color:#f92672">&amp;</span>next_date, rtc);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Important: Handle case when next logging time exceeds end time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (next_hour <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">24</span>)  <span style="color:#75715e">// When it goes to next day
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((next_hour <span style="color:#f92672">%</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&gt;=</span> s.end_h)  <span style="color:#75715e">// When it exceeds end time of next day
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          next_hour <span style="color:#f92672">=</span> s.start_h;
</span></span><span style="display:flex;"><span>          next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>          next_date <span style="color:#f92672">=</span> rtc.day() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// Start time of next day
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>  <span style="color:#75715e">// Normal schedule (no date crossing)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((rtc.hour() <span style="color:#f92672">&gt;=</span> s.start_h) <span style="color:#f92672">&amp;</span> (rtc.hour() <span style="color:#f92672">&lt;=</span> s.end_h))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      findMinute(s, <span style="color:#f92672">&amp;</span>next_minute, <span style="color:#f92672">&amp;</span>next_hour, <span style="color:#f92672">&amp;</span>next_date, rtc);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (rtc.hour() <span style="color:#f92672">&lt;</span> s.start_h) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      next_hour <span style="color:#f92672">=</span> s.start_h;
</span></span><span style="display:flex;"><span>      next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>      next_date <span style="color:#f92672">=</span> rtc.day();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      next_hour <span style="color:#f92672">=</span> s.start_h;
</span></span><span style="display:flex;"><span>      next_minute <span style="color:#f92672">=</span> s.m[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>      next_date <span style="color:#f92672">=</span> rtc.day() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Specify logging start time down to seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  RtcTime rtc_record_start <span style="color:#f92672">=</span> RtcTime(rtc.year(), rtc.month(), next_date, 
</span></span><span style="display:flex;"><span>                                     next_hour, next_minute, logging_start_second);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Boot time is boot_to_record_delay seconds before logging start time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  RtcTime rtc_to_alarm <span style="color:#f92672">=</span> rtc_record_start <span style="color:#f92672">-</span> boot_to_record_delay;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  String str_record <span style="color:#f92672">=</span> printClock(rtc_record_start); 
</span></span><span style="display:flex;"><span>  String str_boot <span style="color:#f92672">=</span> printClock(rtc_to_alarm);
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Next logging time: &#34;</span> <span style="color:#f92672">+</span> str_record);
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Next boot time: &#34;</span> <span style="color:#f92672">+</span> str_boot);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> sleep_sec <span style="color:#f92672">=</span> rtc_to_alarm.unixtime() <span style="color:#f92672">-</span> rtc.unixtime();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (sleep_sec <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    sleep_sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> sleep_sec;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* For operating the Ultrasonic Level Sensor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-----------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// calulate CRC16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">uint16_t</span> <span style="color:#a6e22e">calcCRC16</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">uint8_t</span> len) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> crc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFF</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">uint8_t</span> pos<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; pos<span style="color:#f92672">&lt;</span>len; pos<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    crc <span style="color:#f92672">^=</span> (<span style="color:#66d9ef">uint16_t</span>)buf[pos];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">uint8_t</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">8</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (crc <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0001</span>) {
</span></span><span style="display:flex;"><span>        crc <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        crc <span style="color:#f92672">^=</span> <span style="color:#ae81ff">0xA001</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        crc <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> crc;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendReadCommand</span>(<span style="color:#66d9ef">uint8_t</span> slave, <span style="color:#66d9ef">uint8_t</span> func, <span style="color:#66d9ef">uint16_t</span> reg, <span style="color:#66d9ef">uint16_t</span> count) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> buf[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> slave;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> func;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (reg <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> reg <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (count <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> count <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> crc <span style="color:#f92672">=</span> calcCRC16(buf, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> crc <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>  buf[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> (crc <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  digitalWrite(RS485_TXEN_PIN, HIGH); <span style="color:#75715e">// 送信モード
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  RS485_SERIAL.write(buf, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>  RS485_SERIAL.flush();
</span></span><span style="display:flex;"><span>  digitalWrite(RS485_TXEN_PIN, LOW);  <span style="color:#75715e">// 受信モード
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">readResponse</span>(<span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">&amp;</span>distance_mm) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 適切なバッファ長（例、返りバイト数6＋データ？）を監視
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (RS485_SERIAL.available() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> header[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>  RS485_SERIAL.readBytes(header, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// header[0]=slave, header[1]=func, header[2]=byte count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint8_t</span> byteCount <span style="color:#f92672">=</span> header[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (byteCount <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> data[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  RS485_SERIAL.readBytes(data, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> crcBytes[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  RS485_SERIAL.readBytes(crcBytes, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// CRCチェック
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint8_t</span> checkBuf[<span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>  checkBuf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> header[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  checkBuf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> header[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  checkBuf[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> header[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  checkBuf[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  checkBuf[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> calc <span style="color:#f92672">=</span> calcCRC16(checkBuf, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> rec <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">uint16_t</span>)crcBytes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> crcBytes[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (calc <span style="color:#f92672">!=</span> rec) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  distance_mm <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">uint16_t</span>)data[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> data[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// num_count回分の計測を1ファイルに書き込む
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">logCSV</span>() {
</span></span><span style="display:flex;"><span>  RtcTime now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ファイル名生成（開始時刻）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> filename[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>  snprintf(filename, <span style="color:#66d9ef">sizeof</span>(filename),
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#34;%04d%02d%02d_%02d%02d.csv&#34;</span>,
</span></span><span style="display:flex;"><span>           now.year(), now.month(), now.day(),
</span></span><span style="display:flex;"><span>           now.hour(), now.minute());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  File f <span style="color:#f92672">=</span> theSD.open(filename, FILE_WRITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>f) {
</span></span><span style="display:flex;"><span>    DEBUG_PRINTLN(<span style="color:#e6db74">&#34;File open failed&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// CSVヘッダー
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  f.println(<span style="color:#e6db74">&#34;Datetime,Distance_mm&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DEBUG_PRINT(<span style="color:#e6db74">&#34;Logging to: &#34;</span>);
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(filename);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// num_count回の計測ループ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sendReadCommand(SLAVE_ADDR, FUNC_READ, REG_DISTANCE, <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// 一回空打ちしておく
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  delay(measure_interval_ms);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> num_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> dist;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> ok <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sendReadCommand(SLAVE_ADDR, FUNC_READ, REG_DISTANCE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> t0 <span style="color:#f92672">=</span> millis();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (millis() <span style="color:#f92672">-</span> t0 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">300</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (readResponse(dist)) {
</span></span><span style="display:flex;"><span>        ok <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 現在時刻を取得
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 書き込み
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (ok) {
</span></span><span style="display:flex;"><span>      f.printf(<span style="color:#e6db74">&#34;%04d-%02d-%02d %02d:%02d:%02d,%u</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>               now.year(), now.month(), now.day(),
</span></span><span style="display:flex;"><span>               now.hour(), now.minute(), now.second(),
</span></span><span style="display:flex;"><span>               dist);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Read error&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    delay(measure_interval_ms);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ファイルを閉じる（安全）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  f.close();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Logging complete.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  DEBUG_BEGIN(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  LowPower.clockMode(CLOCK_MODE_32MHz);
</span></span><span style="display:flex;"><span>  board_xtal_power_control(true);
</span></span><span style="display:flex;"><span>  pinMode(GNSS_STATUS_LED, OUTPUT);
</span></span><span style="display:flex;"><span>  digitalWrite(GNSS_STATUS_LED, HIGH);
</span></span><span style="display:flex;"><span>  delay(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Setup timelapse functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;Starting!&#34;</span>);
</span></span><span style="display:flex;"><span>  setRTC();
</span></span><span style="display:flex;"><span>  setLowPower();
</span></span><span style="display:flex;"><span>  Watchdog.begin();
</span></span><span style="display:flex;"><span>  Watchdog.start(wd_time);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Setup Level sensor functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  RS485_SERIAL.begin(<span style="color:#ae81ff">9600</span>);
</span></span><span style="display:flex;"><span>  pinMode(RS485_TXEN_PIN, OUTPUT);
</span></span><span style="display:flex;"><span>  digitalWrite(RS485_TXEN_PIN, LOW);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>theSD.begin()) {
</span></span><span style="display:flex;"><span>    DEBUG_PRINTLN(<span style="color:#e6db74">&#34;SD init failed&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  DEBUG_PRINTLN(<span style="color:#e6db74">&#34;SD OK&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> rec_ok <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>String file_name;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> sleep_sec;
</span></span><span style="display:flex;"><span>RtcTime now;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  Watchdog.kick();
</span></span><span style="display:flex;"><span>  waitUntilShootTime();
</span></span><span style="display:flex;"><span>  logCSV();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  now <span style="color:#f92672">=</span> RTC.getTime();
</span></span><span style="display:flex;"><span>  sleep_sec <span style="color:#f92672">=</span> getNextAlarm(s, now);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (sleep_sec <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DEBUG_PRINT(<span style="color:#e6db74">&#34;Go to deep sleep...&#34;</span>);
</span></span><span style="display:flex;"><span>    LowPower.clockMode(CLOCK_MODE_8MHz);
</span></span><span style="display:flex;"><span>    board_xtal_power_control(false);
</span></span><span style="display:flex;"><span>    LowPower.deepSleep(sleep_sec);
</span></span><span style="display:flex;"><span>  } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></details>
<h2 id="消費電力">消費電力</h2>
<p>電池の持ちを予測するために、消費電力を計測しました。計測には、NORDIC Semiconの<a href="https://www.nordicsemi.jp/tools/ppk2/">Power Profiler Kit 2 (ppk2)</a>を使いました。</p>
<p>まずはロギング時の消費電力を見てみます。
ロギング開始前の待機時間にちょっと消費電流が大きいですね&hellip;
<code>waitUntilShootTime()</code>をもう少し工夫した方がいいのかもしれませんが、トータルで 24.22 * 27.83 = 675 mAs = 0.1875 mAh 使っていることがわかります。</p>
<p><img src="../../images/snowdepth_logger/power_consumption_logging.png" alt=""></p>
<p>次にディープスリープ時の消費電力です。<a href="https://ja.stackoverflow.com/questions/55366/sony-spresense-deep-sleep%E3%81%A7%E3%81%AE%E9%9B%BB%E5%8A%9B">色々工夫すればもっと減らせそう</a>ですが、現状 5.43 mA 程度使っている様ですね。</p>
<p><img src="../../images/snowdepth_logger/power_consumption_sleeping.png" alt=""></p>
<p>以上から、毎時1回ロギングした場合の1日あたりの消費電力を計算します。</p>
<p>まず、ディープスリープ時に 5.43 * 24 = 130.32 mAh 使います。</p>
<p>それに加えてロギング時に、
0.1875 * 24 = 4.5 mAh = 22.5 mWh 使います。</p>
<p>アルカリ乾電池は一般に寒さに弱いため、使うとしたらリチウム乾電池か、エネループのようなニッケル水素充電池でしょう。
一応、距離計の動作電圧は5~12Vとなっているため、1.2Vのニッケル水素4本だと電圧が若干足りません。問題ない気もしますが、リチウム乾電池を使う想定にします。</p>
<p>一般的なリチウム乾電池の容量は3000 mAh程度だと考えられるので、4本つけた際の容量は 3000 mAh * 6 V = 18000 mWh 程度だと思われます。</p>
<p>したがって、理想的には18000 / 22.5 = 800 日間持つ想定です。（本当か！？）</p>
<h2 id="使ってみた">使ってみた</h2>
<p>今冬長野の山奥で試験予定です！Coming Soon!</p>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="../../tags/spresense">Spresense</a></li>
              
              <li><a href="../../tags/arduino">Arduino</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/0kam" rel="me" title="GitHub">
      <svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
    </a>
    <a class="border"></a><a class="soc" href="https://x.com/okamoto_ryotaro" rel="me" title="Twitter">
      <svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
    </a>
    <a class="border"></a><a class="soc" href="https://www.facebook.com/profile.php?id=100010006816605" rel="me" title="Facebook">
      <svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
    </a>
    <a class="border"></a></div>
  <div class="footer-info">
    2025  © okamoto |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>

</div>
    </body>
</html>
